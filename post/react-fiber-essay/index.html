
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>React Fiber Essay | å››è¾…çš„åšå®¢</title>
<meta name="description" content="æ¸©æ•…è€ŒçŸ¥æ–°">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="shortcut icon" href="https://sfmonkey.github.io//favicon.ico">
<link rel="stylesheet" href="https://sfmonkey.github.io//styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>


  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://sfmonkey.github.io/">
        <img class="avatar" src="https://sfmonkey.github.io//images/avatar.png" alt="" width="32px" height="32px">
      </a>
      <a href="https://sfmonkey.github.io/">
        <h1 class="site-title">å››è¾…çš„åšå®¢</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            å…³äº
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          <h2 class="post-title">React Fiber Essay</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2020-03-20</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://sfmonkey.github.io//tag/t1GPgLh46">
                    React
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://sfmonkey.github.io//tag/yldW1tuxF">
                    Essay
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content">
            <h3 id="æ¦‚è¦">æ¦‚è¦</h3>
<p>å½“æˆ‘ä»¬äº†è§£ stck reconcilerï¼ˆreact 16.0 ä¹‹å‰çš„ diff ç®—æ³•ï¼‰åï¼Œæˆ‘ä»¬çŸ¥é“ React åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œ setState å¤„ç†æ›´æ–°æ—¶ï¼Œä¼šå› ä¸ºè™šæ‹ŸDOM è¿›è¡Œ diff è€Œ<strong>ä¸€é¼“ä½œæ°”</strong>é•¿æ—¶é—´å ç”¨ä¸»çº¿ç¨‹ï¼Œå»æ¯”è¾ƒè¯¥ç»„ä»¶åŠå…¶å­ç»„ä»¶ï¼Œå¯¼è‡´ä¸€äº›é«˜çº§åˆ«çš„ä»»åŠ¡ï¼Œæ¯”å¦‚ç”¨æˆ·è¾“å…¥å’ŒåŠ¨ç”»æ‰§è¡Œå‡ºç°å»¶è¿Ÿå¡é¡¿ï¼Œè€Œ Fiber åœ¨ react ä¸­çš„å¼•å…¥ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><strong>å¦‚æœæ˜¯100ç±³çŸ­è·‘ï¼Œæˆ–è€…1000ç±³ç«èµ›ï¼Œå½“ç„¶è¶Šå¿«è¶Šå¥½ã€‚å¦‚æœæ˜¯é©¬æ‹‰æ¾ï¼Œå°±éœ€è¦è€ƒè™‘åˆ°ä¿å­˜ä½“åŠ›äº†ï¼Œéœ€è¦æ³¨æ„ä¼‘æ¯äº†ã€‚æ€§èƒ½æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§çš„å·¥ç¨‹ã€‚</strong></p>
<p>æ—¢ç„¶æˆ‘ä»¬è¦å»å’Œ fiber åšæœ‹å‹äº†ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å»å°è¯•äº†è§£ä¸€ä¸‹å®ƒï¼Œå®ƒæ˜¯æ€ä¹ˆåšåˆ°èƒ½å¤Ÿè§£å†³ä¸Šé¢çš„é—®é¢˜çš„</p>
<ul>
<li>
<p>requestIdleCallback</p>
</li>
<li>
<p>vdom æ ‘å½¢ è½¬æ¢åˆ° Fiber é“¾å¼ï¼ˆReconciliation Phaseï¼‰</p>
</li>
<li>
<p>ğŸš¢æ–°çš„ diff ç®—æ³•ï¼ˆReconciliation Phaseï¼‰</p>
</li>
<li>
<p>Fiber è½¬æ¢ä¸ºçœŸå® DOMï¼ˆCommit Phaseï¼‰</p>
</li>
</ul>
<h3 id="requestidlecallback">requestIdleCallback</h3>
<p><strong>requestIdleCallback æ˜¯åœ¨æµè§ˆå™¨ç©ºé—²æ—¶ä¼šæ‰§è¡Œå¯¹åº” callback çš„ API</strong></p>
<p>é¡µé¢ä¸€å¸§ä¸€å¸§ç»˜åˆ¶å‡ºæ¥çš„ï¼Œå½“æ¯ç§’ç»˜åˆ¶çš„å¸§æ•°ï¼ˆFPSï¼‰è¾¾åˆ° 60 æ—¶ï¼Œé¡µé¢æ˜¯æµç•…çš„ï¼Œå°äºè¿™ä¸ªå€¼æ—¶ï¼Œç”¨æˆ·ä¼šæ„Ÿè§‰åˆ°å¡é¡¿ã€‚</p>
<p>1s 60å¸§ï¼Œæ‰€ä»¥æ¯ä¸€å¸§åˆ†åˆ°çš„æ—¶é—´æ˜¯ 1000/60 â‰ˆ 16 msã€‚æ‰€ä»¥æˆ‘ä»¬ä¹¦å†™ä»£ç æ—¶åŠ›æ±‚ä¸è®©ä¸€å¸§çš„å·¥ä½œé‡è¶…è¿‡ 16msã€‚</p>
<p><img src="https://sfmonkey.github.io//post-images/1584699602216.jpeg" alt=""></p>
<p>è¿™æ˜¯æµè§ˆå™¨ä¸€å¸§å†…çš„å·¥ä½œ</p>
<p>ä¸Šé¢å…­ä¸ªæ­¥éª¤å®Œæˆåæ²¡è¶…è¿‡ 16 msï¼Œè¯´æ˜æ—¶é—´æœ‰å¯Œä½™ï¼Œæ­¤æ—¶å°±ä¼šæ‰§è¡Œ requestIdleCallback é‡Œæ³¨å†Œçš„ä»»åŠ¡ã€‚</p>
<h3 id="fiber">Fiber</h3>
<ul>
<li>
<p>å› ä¸º createElement è¿”å›çš„ç»“æœæ˜¯ vnode ï¼Œæˆ‘ä»¬éœ€è¦å°† vnode æ ‘è½¬æ¢ä¸º fiber é“¾è¡¨ã€‚å› ä¸ºé“¾è¡¨çš„ç»“æ„å¤©ç„¶é€‚åˆæˆ‘ä»¬è¿›è¡Œä»»åŠ¡çš„æš‚åœã€‚</p>
<pre><code class="language-js">//ReactDom.js

// ä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡
// let nextUnitOfWork = null;
// work in progress å·¥ä½œä¸­çš„ fiber root
let wrokInProgressRoot = null;
// ç°åœ¨çš„æ ¹èŠ‚ç‚¹
let currentRoot = null;

function render(vnode, container) {
	wrokInProgressRoot = {
		node: container,
		props: {children: [vnode]},
		base: currentRoot
	}

	nextUnitOfWork = wrokInProgressRoot;
}

function reconcilerChilren(workInProgressFiber, children) {
	let prevSibling = null;
	let oldFiber = workInProgressFiber.base &amp;&amp; workInProgressFiber.base.child;
	for(let i = 0; i &lt; children.length; i ++) {
		let child = children[i];
		let newFiber = null;

		newFiber = {
			type: child.type,
			props: child.props,
			node: null,
			base: null,
			parent: workInProgressFiber,
			effectTag: PLACEMENT
		}

		if (oldFiber) {
			oldFiber = oldFiber.sibling
		}

		if (i === 0) {
			workInProgressFiber.child = newFiber;
		} else {
			prevSibling.sibiling = newFiber;
		}

		prevSibling = newFiber;
	}
}

function updateClassComponent(fiber) {
	const {type, props} = fiber;
	const cmp = new type(props);
	const children = [cmp.render()];
	reconcilerChilren(fiber, children);
}

function updateFunctionComponent(fiber) {
	const {type, props} = fiber;
	const children = [type(props)];
	reconcilerChilren(fiber, children);
}

function updateHostComponent(fiber) {
	if (!fiber.node) {
		fiber.node = createNode(fiber);
	}

	const children = fiber.props;
	reconcilerChilren(fiber, children);
}

function preformUnitOfWork (fiber) {
	const {type} = fiber;

	if (typeof type === 'function') {
		type.isReactComponent ? 
			updateClassComponent(fiber) : 
			updateFunctionComponent(fiber)
	} else {
		updateHostComponent(fiber);
	}

	if (fiber.child) {
		return fiber.child;
	}

	let nextFiber = fiber;
	while(nextFiber) {
		if (nextFiber.sibling) {
			return nextFiber.sibling
		}
		nextFiber = nextFiber.parent;
	}
}

function workLoop(deadline) {
	while(nextUnitOfWork &amp;&amp; deadline.timeRemaining() &gt; 1) {
		nextUnitOfWork = preformUnitOfWork(nextUnitOfWork);
	}

	if (!nextUnitOfWork &amp;&amp; wrokInProgressRoot) {
		commitRoot();
	}
}

requestIdleCallback(workLoop)
</code></pre>
</li>
<li>
<p>Fiber diffç®—æ³•
å¾…æ›´æ–°</p>
</li>
<li>
<p>ç„¶åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Commit Phase é˜¶æ®µï¼Œå°† Fiber è½¬æ¢ä¸ºçœŸå® DOMï¼Œåœ¨ Reconcilition Phase é˜¶æ®µæˆ‘ä»¬å¯ä»¥æš‚åœå»æ‰§è¡Œå…¶ä»–é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œä½†æ˜¯åœ¨ Commit é˜¶æ®µï¼Œè¿™ä¸ªæ›´æ–°æ˜¯ä¸€æ°”å‘µæˆçš„ï¼Œå› ä¸ºè¿™æ˜¯ç”¨æˆ·è¦çœ‹åˆ°çš„ UI é˜¶æ®µã€‚</p>
<pre><code class="language-js">function commitRoot() {
	commitWorker(wrokInProgressRoot.child);
	currentRoot = wrokInProgressRoot;
	wrokInProgressRoot = null;
}

function commitWorker(fiber) {
	if(!fiber) {
		return
	}

	let parentNodeFiber = fiber.parent;
	while (!parentNodeFiber.node) {
		parentNodeFiber = parentNodeFiber.parent;
	}

	const parentNode = parentNodeFiber.node;
	// æ›´æ–° åˆ é™¤ æ–°å¢
	if (fiber.effectTag === PLACEMENT &amp;&amp; fiber.node !== null) {
		parentNode.appendChild(fiber.node);
	}
	commitWorker(fiber.child);
	commitWorker(fiber.sibling);
}
</code></pre>
</li>
</ul>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a href="https://www.cnblogs.com/Wayou/p/requestIdleCallback.html">åˆ©ç”¨å¥½æµè§ˆå™¨çš„ç©ºé—²æ—¶é—´ --- requestIdleCallback</a>
<a href="https://juejin.im/post/5ab7b3a2f265da2378403e57">React Fiber</a>
<a href="http://www.ayqy.net/blog/dive-into-react-fiber/">å®Œå…¨ç†è§£React Fiber</a>
<a href="https://zhuanlan.zhihu.com/p/37095662">React Fiberæ¶æ„</a></p>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://sfmonkey.github.io//post/react-diff-essay">
              <h3 class="post-title">
                ä¸‹ä¸€ç¯‡ï¼šReact diff Essay
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan">æ¸©æ•…è€ŒçŸ¥æ–°</div>
  Powered by Hve Notes
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
