
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>React diff Essay | å››è¾…çš„åšå®¢</title>
<meta name="description" content="æ¸©æ•…è€ŒçŸ¥æ–°">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="shortcut icon" href="https://sfmonkey.github.io//favicon.ico">
<link rel="stylesheet" href="https://sfmonkey.github.io//styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>


  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://sfmonkey.github.io/">
        <img class="avatar" src="https://sfmonkey.github.io//images/avatar.png" alt="" width="32px" height="32px">
      </a>
      <a href="https://sfmonkey.github.io/">
        <h1 class="site-title">å››è¾…çš„åšå®¢</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            å…³äº
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          <h2 class="post-title">React diff Essay</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2020-03-19</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://sfmonkey.github.io//tag/t1GPgLh46">
                    React
                    
                      ï¼Œ
                    
                  </a>
                
                  <a href="https://sfmonkey.github.io//tag/yldW1tuxF">
                    Essay
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content">
            <h3 id="æ¦‚è¦">æ¦‚è¦</h3>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œreact ä¸­æ˜¯é€šè¿‡ setState æ¥è§¦å‘ç»„ä»¶ render å‡½æ•°ï¼Œå¾—åˆ°è™šæ‹Ÿ DOMï¼Œç„¶å oldVnode ä¸ vnode è¿›è¡Œ diff ï¼Œæœ€åå¾—åˆ°é«˜æ•ˆçš„ DOM æ›´æ–°æ“ä½œã€‚</p>
<p>åœ¨ React diff ä¸­ï¼Œæ›´æ–°ç­–ç•¥æœ‰ä¸‰ç‚¹</p>
<ol>
<li>Web UI ä¸­ DOM èŠ‚ç‚¹è·¨å±‚çº§çš„ç§»åŠ¨æ“ä½œç‰¹åˆ«å°‘ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡</li>
<li>æ‹¥æœ‰ç›¸åŒç±»çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆç›¸ä¼¼çš„æ ‘å½¢ç»“æ„ï¼Œæ‹¥æœ‰ä¸åŒç±»çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆä¸åŒçš„æ ‘å½¢ç»“æ„</li>
<li>å¯¹äºåŒä¸€å±‚çº§çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡å”¯ä¸€ id è¿›è¡ŒåŒºåˆ†</li>
</ol>
<p>åŸºäºè¿™ä¸‰ä¸ªæ›´æ–°ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡º React diff ä¸­ä¸‰ç§ä¸åŒçš„ diff ç±»å‹</p>
<ol>
<li>tree diff</li>
<li>component diff</li>
<li>element diff</li>
</ol>
<h3 id="tree-diff">tree diff</h3>
<p>React å¯¹ğŸŒ²çš„ç®—æ³•è¿›è¡Œäº†ç®€æ´æ˜äº†çš„ä¼˜åŒ–ï¼Œå³å¯¹æ ‘è¿›è¡Œåˆ†å±‚æ¯”è¾ƒï¼Œä¸¤æ£µæ ‘åªä¼šå¯¹åŒä¸€å±‚æ¬¡çš„èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚</p>
<ul>
<li>
<p>é¦–å…ˆæˆ‘ä»¬æ¥æ§åˆ¶åŒå±‚æ¯”è¾ƒ</p>
<pre><code class="language-js">_updateChildren: function(      
	nextNestedChildrenElements,
	transaction,
	context,
) {
	...
	var nextChildren = this._reconcilerUpdateChildren(
		prevChildren,
		nextNestedChildrenElements,
		mountImages,
		removedNodes,
		transaction,
		context,
	);
}
</code></pre>
<p>prevChildren å’Œ nextChildren å°±æ˜¯å¯¹åº”çš„è™šæ‹Ÿ DOMï¼ŒnextNestedChildrenElements è¿™ç©æ„å„¿æ˜¯ä¸ªæŒ‡é’ˆï¼Œæ¥æ ‡æ˜å½“å‰æ ‘çš„å±‚æ¬¡ï¼Œå¾—åˆ°å½“å‰ prevChildren çš„å±‚æ¬¡ã€‚</p>
</li>
<li>
<p>ç„¶å ReactChildReconciler.updateChildren ä¼šå°† prevChildrenã€nextChildrenå°è£…æˆReactDOMComponentç±»å‹ï¼Œå¹¶è¿›è¡Œåç»­æ¯”è¾ƒå’Œæ“ä½œã€‚</p>
</li>
</ul>
<p>æ‰€ä»¥å½“å‡ºç°èŠ‚ç‚¹è·¨å±‚çº§ç§»åŠ¨æ—¶ï¼Œå¹¶ä¸ä¼šå‡ºç°æƒ³è±¡ä¸­çš„ç§»åŠ¨æ“ä½œï¼Œè€Œæ˜¯ä»¥ A ä¸ºæ ¹èŠ‚ç‚¹çš„æ ‘è¢«æ•´ä¸ªé‡æ–°åˆ›å»ºï¼Œè¿™æ˜¯ä¸€ç§å½±å“ React æ€§èƒ½çš„æ“ä½œï¼Œå› æ­¤ <strong>React å®˜æ–¹å»ºè®®ä¸å‹è¿«è¿›è¡Œ DOM èŠ‚ç‚¹è·¨å±‚çº§çš„æ“ä½œ</strong></p>
<p><img src="https://sfmonkey.github.io//post-images/1584599830004.jpeg" alt=""></p>
<h3 id="component-diff">component diff</h3>
<p>æˆ‘ä»¬éœ€è¦æ¸…æ¥šçš„æ˜¯ï¼ŒcreateElement ç”Ÿæˆçš„è™šæ‹Ÿ DOMï¼Œå¦‚æœèŠ‚ç‚¹æœ¬èº«æ˜¯ç»„ä»¶ï¼Œé‚£ä¹ˆè™šæ‹Ÿ DOM ä¸­çš„ tag å…¶å®å°±æ˜¯å¯¹åº”çš„ class æˆ–è€… functionï¼Œè¿™ä¸ªåœ¨ä¹‹å‰æˆ‘ä»¬å®ç° react çš„æ—¶å€™å°±å·²ç»æœ‰ä½“ç°äº†ã€‚å½“ç„¶è¿™æ˜¯ react è™šæ‹Ÿ DOMï¼Œåœ¨ vue ä¸­ tag ä¸å¤ªä¸€æ ·ï¼Œè¿™æ˜¯åè¯ã€‚</p>
<ul>
<li>
<p>å¦‚æœæ˜¯åŒä¸€ç±»å‹çš„ç»„ä»¶ï¼ŒæŒ‰ç…§åŸç­–ç•¥ç»§ç»­æ¯”è¾ƒè™šæ‹Ÿ DOM æ ‘</p>
</li>
<li>
<p>å¦‚æœä¸æ˜¯ï¼Œåˆ™å°†è¯¥ç»„ä»¶åˆ¤æ–­ä¸º dirty componentï¼Œä»è€Œæ›¿æ¢æ•´ä¸ªç»„ä»¶ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹</p>
</li>
<li>
<p>å¯¹äºåŒä¸€ç±»å‹çš„ç»„ä»¶ï¼Œæœ‰å¯èƒ½å…¶ Virtual DOM æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œè¿™æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ shouldComponentUpdate é’©å­æ¥å‘Šè¯‰è¯¥ç»„ä»¶æ˜¯å¦è¿›è¡Œ diffï¼Œä»è€Œæé«˜å¤§é‡çš„æ€§èƒ½ã€‚</p>
<pre><code>// è¶…ç®€å•ä»£ç å®ç°
const compareTwoVnodes(oldVnode, newVnode, dom) {
		let newNode = dom

		// å¦‚æœæ–°çš„è™šæ‹ŸDOMæ˜¯nullï¼Œé‚£ä¹ˆå°±å°†å‰ä¸€æ¬¡çš„çœŸå®DOMç§»é™¤æ‰
		if (newVnode == null) {
				destroyVnode(oldVnode, dom)
				dom.parentNode.removeChild(dom)

		} else if (oldVnode.type !== newVnode.type || oldVnode.key !== newVnode.key) {
				// replace
				destroyVnode(oldVnode, dom)
				newNode = initVnode(newVnode, parentContext, dom.namespaceURI)
				dom.parentNode.replaceChild(newNode, dom)

		} else if (oldVnode !== newVnode || parentContext) {
				// same type and same key -&gt; update
				newNode = updateVNode(oldVnode, newVnode, dom, parentContext)
		}
}
/** 
* æ›´æ–°è™šæ‹ŸDOM
* è¿™é‡Œçš„typeéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œå¦‚æœvnodeæ˜¯ä¸ªhtmlå…ƒç´ ï¼Œä¾‹å¦‚h1ï¼Œé‚£ä¹ˆtypeå°±æ˜¯'h1'
** å¦‚æœvnodeæ˜¯ä¸€ä¸ªå‡½æ•°ç»„ä»¶ï¼Œä¾‹å¦‚const Header = () =&gt; &lt;h1&gt;header&lt;/h1&gt;ï¼Œé‚£ä¹ˆtypeå°±æ˜¯å‡½æ•°Header
** å¦‚æœvnodeæ˜¯ä¸€ä¸ªclassç»„ä»¶ï¼Œé‚£ä¹ˆtypeå°±æ˜¯é‚£ä¸ªclass
*/
const updateVNode = (vnode, node) =&gt; {
		const { type } = vnode; // typeæ˜¯æŒ‡è™šæ‹ŸDOMçš„ç±»å‹
		// å¦‚æœæ˜¯classç»„ä»¶
		if (type === VCOMPONENT) {
				return updateComponent(vnode, node)
		} else (type === VSTATELESS){
				return updateStateLess(vnode, node)
		}
		updateVChildren(vnode, node)
}
// æ›´æ–°classç»„ä»¶ï¼ˆè°ƒç”¨renderæ–¹æ³•æ‹¿åˆ°æ–°çš„è™šæ‹ŸDOMï¼‰
const updateComponent = (vnode, node) =&gt; {
		const { type: Component } = vnode; // typeæ˜¯æŒ‡è™šæ‹ŸDOMçš„ç±»å‹
		const newVNode = new Component().render();
		compareTwoVnodes(newVNode, vnode, node);
}
// æ›´æ–°æ— çŠ¶æ€ç»„ä»¶ï¼ˆç›´æ¥æ‰§è¡Œå‡½æ•°æ‹¿åˆ°æ–°çš„è™šæ‹ŸDOMï¼‰
const updateStateLess = (vnode, node) =&gt; {
		const { type: Component } = vnode; // typeæ˜¯æŒ‡è™šæ‹ŸDOMçš„ç±»å‹
		const newVNode = Component();
		compareTwoVnodes(newVNode, vnode, node);
}
const updateVChildren = (vnode, node) =&gt; {
		for (let i = 0; i &lt; node.children.length; i++) {
				updateVNode(vnode.children[i], node.children[i])
		}
}
</code></pre>
</li>
</ul>
<h3 id="element-diff">element diff</h3>
<p>å½“èŠ‚ç‚¹å¤„äºåŒä¸€å±‚çº§æ—¶ï¼ŒReact diff æä¾›äº†ä¸‰ç§èŠ‚ç‚¹æ“ä½œ</p>
<pre><code class="language-js">// oldDomsæ˜¯çœŸå®DOMï¼ŒnewDomsæ˜¯æœ€æ–°çš„è™šæ‹ŸDOM
const oldDoms = [A, B, C, D],
	newDoms = [B, A, E, D],
	updates = [],
	removes = [],
	creates = [];
// è¿›è¡Œä¸¤å±‚éå†ï¼Œè·å–åˆ°å“ªäº›èŠ‚ç‚¹éœ€è¦æ›´æ–°ï¼Œå“ªäº›èŠ‚ç‚¹éœ€è¦ç§»é™¤ã€‚
for (let i = 0; i &lt; oldDoms.length; i++) {
	const oldDom = oldDoms[i]
	let shouldRemove = true
	for (let j = 0; j &lt; newDoms.length; j++) {
		const newDom = newDoms[j];
		if (
				oldDom.key === newDom.key &amp;&amp;
				oldDom.type === newDom.type
		) {
				updates[j] = {
						index: j,
						node: oldDom,
						parentNode: parentNode // è¿™é‡ŒçœŸå®DOMçš„çˆ¶èŠ‚ç‚¹
				}
				shouldRemove = false
		}
	}
	if (shouldRemove) {
			removes.push({
					node: oldDom
			})
	}
}
// ä»è™šæ‹ŸDOMèŠ‚ç‚¹æ¥å–å‡ºä¸è¦æ›´æ–°çš„èŠ‚ç‚¹ï¼Œè¿™å°±æ˜¯éœ€è¦æ–°åˆ›å»ºçš„èŠ‚ç‚¹ã€‚
for (let j = 0; j &lt; newDoms.length; j++) {
	if (!updates[j]) {
			creates.push({
					index: j,
					vnode: newDoms[j],
					parentNode: parentNode // è¿™é‡ŒçœŸå®DOMçš„çˆ¶èŠ‚ç‚¹
			})
	}
}
</code></pre>
<ul>
<li>
<p>æ’å…¥</p>
<pre><code class="language-js">const create = (creates) =&gt; {
		creates.forEach(create =&gt; {
				const index = create.index,
						parentNode = create.parentNode,
						vnode = create.vnode,
						curNode = parentNode.children[index],
						node = createNode(vnode); // åˆ›å»ºDOMèŠ‚ç‚¹
				parentNode.insertBefore(node, curNode)
		})
}
</code></pre>
</li>
<li>
<p>ç§»åŠ¨</p>
<pre><code class="language-js">const update = (updates) =&gt; {
		updates.forEach(update =&gt; {
				const index = update.index,
						parentNode = update.parentNode,
						node = update.node,
						curNode = parentNode.children[index];
				if (curNode !== node) {
						parentNode.insertBefore(node, curNode)
				}
		})
}
</code></pre>
</li>
<li>
<p>åˆ é™¤</p>
<pre><code class="language-js">const remove = (removes) =&gt; {
		removes.forEach(remove =&gt; {
				const node = remove.node
				node.parentNode.removeChild(node)
		})
}
</code></pre>
</li>
</ul>
<h3 id="åç»­">åç»­</h3>
<ul>
<li>
<p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆèƒ½å¼•å‡ºä¸€ä¸ªæ€è€ƒğŸ¤”ï¼Œé‚£å°±æ˜¯ vue ä¸ React diff ç®—æ³•çš„ä¸åŒ</p>
<ul>
<li>react æœ‰ compnent diffï¼Œè€Œ vue æ²¡æœ‰</li>
</ul>
<blockquote>
<p>åœ¨ React åº”ç”¨ä¸­ï¼Œå½“æŸä¸ªç»„ä»¶çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¼šä»¥è¯¥ç»„ä»¶ä¸ºæ ¹ï¼Œé‡æ–°æ¸²æŸ“æ•´ä¸ªç»„ä»¶å­æ ‘ã€‚</p>
<p>å¦‚è¦é¿å…ä¸å¿…è¦çš„å­ç»„ä»¶çš„é‡æ¸²æŸ“ï¼Œä½ éœ€è¦åœ¨æ‰€æœ‰å¯èƒ½çš„åœ°æ–¹ä½¿ç”¨ PureComponentï¼Œæˆ–æ˜¯æ‰‹åŠ¨å®ç° shouldComponentUpdate æ–¹æ³•ã€‚åŒæ—¶ä½ å¯èƒ½ä¼šéœ€è¦ä½¿ç”¨ä¸å¯å˜çš„æ•°æ®ç»“æ„æ¥ä½¿å¾—ä½ çš„ç»„ä»¶æ›´å®¹æ˜“è¢«ä¼˜åŒ–ã€‚</p>
<p>ç„¶è€Œï¼Œä½¿ç”¨ PureComponent å’Œ shouldComponentUpdate æ—¶ï¼Œéœ€è¦ä¿è¯è¯¥ç»„ä»¶çš„æ•´ä¸ªå­æ ‘çš„æ¸²æŸ“è¾“å‡ºéƒ½æ˜¯ç”±è¯¥ç»„ä»¶çš„ props æ‰€å†³å®šçš„ã€‚å¦‚æœä¸ç¬¦åˆè¿™ä¸ªæƒ…å†µï¼Œé‚£ä¹ˆæ­¤ç±»ä¼˜åŒ–å°±ä¼šå¯¼è‡´éš¾ä»¥å¯Ÿè§‰çš„æ¸²æŸ“ç»“æœä¸ä¸€è‡´ã€‚è¿™ä½¿å¾— React ä¸­çš„ç»„ä»¶ä¼˜åŒ–ä¼´éšç€ç›¸å½“çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚</p>
<p>åœ¨ Vue åº”ç”¨ä¸­ï¼Œç»„ä»¶çš„ä¾èµ–æ˜¯åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è‡ªåŠ¨è¿½è¸ªçš„ï¼Œæ‰€ä»¥ç³»ç»Ÿèƒ½ç²¾ç¡®çŸ¥æ™“å“ªä¸ªç»„ä»¶ç¡®å®éœ€è¦è¢«é‡æ¸²æŸ“ã€‚ä½ å¯ä»¥ç†è§£ä¸ºæ¯ä¸€ä¸ªç»„ä»¶éƒ½å·²ç»è‡ªåŠ¨è·å¾—äº† shouldComponentUpdateï¼Œå¹¶ä¸”æ²¡æœ‰ä¸Šè¿°çš„å­æ ‘é—®é¢˜é™åˆ¶ã€‚</p>
<p>Vue çš„è¿™ä¸ªç‰¹ç‚¹ä½¿å¾—å¼€å‘è€…ä¸å†éœ€è¦è€ƒè™‘æ­¤ç±»ä¼˜åŒ–ï¼Œä»è€Œèƒ½å¤Ÿæ›´å¥½åœ°ä¸“æ³¨äºåº”ç”¨æœ¬èº«ã€‚</p>
</blockquote>
<p>æ‰€ä»¥è¯´ï¼ŒReact ä¹‹æ‰€ä»¥ä¼šæœ‰ component çš„æ¯”è¾ƒï¼Œè€Œ vue åœ¨è™šæ‹ŸDOM ä¸º component æ—¶ä¼šè·³è¿‡ diff ï¼Œå°±æ˜¯è¿™ä¸ªåŸå› </p>
<ul>
<li>å‰©ä¸‹çš„ tree diff ä¸ element diff ä¸¤è€…éƒ½æœ‰ï¼Œè™½ç„¶å…·ä½“å®ç°ä¸åŒï¼Œä½†éƒ½æ˜¯æœ‰çš„</li>
</ul>
</li>
<li>
<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬æƒ³è¿™ä¹ˆä¸€ç§åœºæ™¯ğŸ¬ï¼Œå› ä¸º React setState ä¼šæ›´æ–°å…¶ç»„ä»¶ä»¥åŠå®ƒçš„æ‰€æœ‰å­ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¼šå…¨éƒ¨è¿›è¡Œ diff ç®—æ³•å¯¹æ¯”ï¼Œé‚£ä¹ˆåœ¨å­˜åœ¨å¤§é‡å­ç»„ä»¶çš„æƒ…å†µä¸‹ï¼Œè¿™ç§ç®—æ³•æ— ç–‘æ˜¯ååˆ†è€—è´¹æ€§èƒ½çš„ï¼Œæ‰€ä»¥ï¼Œè¿™ä¹Ÿå°±æ˜¯ React å›¢é˜Ÿä¼šè€—æ—¶ä¸¤å¹´çš„æ—¶é—´ï¼Œå°† fiber å¼•å…¥ React çš„åŸå› ã€‚</p>
</li>
</ul>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a href="https://zhuanlan.zhihu.com/p/63964441">react diffç®€å•å®ç°</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/36798520">[è¯‘] Reactæ€§èƒ½ä¼˜åŒ–ï¼šVirtual DomåŸç†æµ…æ</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/20346379">React æºç å‰–æç³»åˆ— ï¼ ä¸å¯æ€è®®çš„ react diff</a></p>
<p><a href="https://zh-hans.reactjs.org/docs/reconciliation.html">åè°ƒ</a></p>
<p><a href="https://segmentfault.com/a/1190000010686582">Reactæºç ä¹‹Diffç®—æ³•</a></p>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://sfmonkey.github.io//post/vue-diff-essay">
              <h3 class="post-title">
                ä¸‹ä¸€ç¯‡ï¼šVue diff Essay
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan">æ¸©æ•…è€ŒçŸ¥æ–°</div>
  Powered by Hve Notes
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
